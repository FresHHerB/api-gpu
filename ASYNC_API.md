# API Ass√≠ncrona - Guia Completo

## üéØ Vis√£o Geral

A API agora suporta dois modos de opera√ß√£o:

| Modo | Quando Usar | Timeout | Resposta |
|------|-------------|---------|----------|
| **S√≠ncrono** | Jobs r√°pidos (<5 min) | 15 minutos | Retorna resultado completo |
| **Ass√≠ncrono** | Jobs longos ou m√∫ltiplos jobs | ‚àû Ilimitado | Retorna jobId imediatamente |

---

## üìä Arquitetura Ass√≠ncrona

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cliente ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚îÇ 1. POST /video/img2vid/async
     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Orquestrador‚îÇ  ‚Üê Retorna jobId IMEDIATAMENTE
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ 2. Submit para RunPod
     ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   RunPod   ‚îÇ  ‚Üê Processa em background
‚îÇ   Worker   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚Üë
     ‚îÇ 3. Cliente consulta status
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cliente ‚îÇ ‚Üí GET /video/job/:jobId
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ Endpoints Ass√≠ncronos

### 1. **Submeter Job (Retorna Imediatamente)**

#### POST /video/caption/async
```bash
curl -X POST http://localhost:3000/video/caption/async \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "url_video": "https://example.com/video.mp4",
    "url_srt": "https://example.com/subtitles.srt",
    "path": "videos/output",
    "output_filename": "video_with_caption.mp4"
  }'
```

**Resposta (imediata):**
```json
{
  "jobId": "abc-123-def",
  "status": "IN_QUEUE",
  "statusUrl": "/video/job/abc-123-def",
  "resultUrl": "/video/job/abc-123-def/result",
  "message": "Job submitted successfully. Use statusUrl to check progress."
}
```

---

#### POST /video/img2vid/async
```bash
curl -X POST http://localhost:3000/video/img2vid/async \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "images": [
      {
        "id": "img1",
        "image_url": "https://example.com/image1.jpg",
        "duracao": 3.0
      },
      {
        "id": "img2",
        "image_url": "https://example.com/image2.jpg",
        "duracao": 4.0
      }
    ],
    "path": "videos/output"
  }'
```

**Resposta:**
```json
{
  "jobId": "xyz-789-ghi",
  "status": "IN_QUEUE",
  "statusUrl": "/video/job/xyz-789-ghi",
  "resultUrl": "/video/job/xyz-789-ghi/result",
  "message": "Job submitted successfully. Use statusUrl to check progress.",
  "estimatedTime": "2-10 minutes depending on image count"
}
```

---

#### POST /video/addaudio/async
```bash
curl -X POST http://localhost:3000/video/addaudio/async \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "url_video": "https://example.com/video.mp4",
    "url_audio": "https://example.com/audio.mp3",
    "path": "videos/output",
    "output_filename": "video_with_audio.mp4"
  }'
```

---

### 2. **Consultar Status do Job**

#### GET /video/job/:jobId
```bash
curl http://localhost:3000/video/job/abc-123-def \
  -H "X-API-Key: your-api-key"
```

**Respostas poss√≠veis:**

**IN_QUEUE:**
```json
{
  "id": "abc-123-def",
  "status": "IN_QUEUE",
  "delayTime": 1500
}
```

**IN_PROGRESS:**
```json
{
  "id": "abc-123-def",
  "status": "IN_PROGRESS",
  "delayTime": 2000,
  "executionTime": 45000
}
```

**COMPLETED:**
```json
{
  "id": "abc-123-def",
  "status": "COMPLETED",
  "delayTime": 2000,
  "executionTime": 120000,
  "output": {
    "videos": [
      {
        "id": "img1",
        "video_url": "https://s3.example.com/video_1.mp4",
        "filename": "video_1.mp4"
      }
    ],
    "message": "Images converted successfully"
  }
}
```

**FAILED:**
```json
{
  "id": "abc-123-def",
  "status": "FAILED",
  "error": "Failed to download image: 404 Not Found"
}
```

---

### 3. **Obter Resultado (Apenas quando completo)**

#### GET /video/job/:jobId/result
```bash
curl http://localhost:3000/video/job/abc-123-def/result \
  -H "X-API-Key: your-api-key"
```

**Se ainda em progresso (HTTP 202):**
```json
{
  "jobId": "abc-123-def",
  "status": "IN_PROGRESS",
  "message": "Job is in progress",
  "statusUrl": "/video/job/abc-123-def"
}
```

**Se completo (HTTP 200):**
```json
{
  "jobId": "abc-123-def",
  "status": "COMPLETED",
  "result": {
    "videos": [...],
    "message": "..."
  },
  "delayTime": 2000,
  "executionTime": 120000
}
```

---

### 4. **Cancelar Job**

#### POST /job/:jobId/cancel
```bash
curl -X POST http://localhost:3000/job/abc-123-def/cancel \
  -H "X-API-Key: your-api-key"
```

**Resposta:**
```json
{
  "message": "Job cancelled successfully",
  "jobId": "abc-123-def"
}
```

---

## üíª Exemplos de Implementa√ß√£o

### **JavaScript/Node.js**

```javascript
// 1. Submeter job
async function submitVideo(images) {
  const response = await fetch('http://localhost:3000/video/img2vid/async', {
    method: 'POST',
    headers: {
      'X-API-Key': 'your-api-key',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ images, path: 'videos/output' })
  });

  const data = await response.json();
  return data.jobId;
}

// 2. Polling de status
async function pollJobStatus(jobId) {
  while (true) {
    const response = await fetch(`http://localhost:3000/video/job/${jobId}`, {
      headers: { 'X-API-Key': 'your-api-key' }
    });

    const status = await response.json();
    console.log(`Status: ${status.status}`);

    if (status.status === 'COMPLETED') {
      return status.output;
    }

    if (status.status === 'FAILED') {
      throw new Error(status.error);
    }

    // Aguarda 3 segundos antes de consultar novamente
    await new Promise(resolve => setTimeout(resolve, 3000));
  }
}

// 3. Uso completo
const jobId = await submitVideo([...]);
const result = await pollJobStatus(jobId);
console.log('Videos:', result.videos);
```

---

### **Python**

```python
import requests
import time

API_URL = "http://localhost:3000"
API_KEY = "your-api-key"
HEADERS = {"X-API-Key": API_KEY, "Content-Type": "application/json"}

# 1. Submeter job
def submit_video(images):
    response = requests.post(
        f"{API_URL}/video/img2vid/async",
        headers=HEADERS,
        json={"images": images, "path": "videos/output"}
    )
    data = response.json()
    return data["jobId"]

# 2. Polling de status
def poll_job_status(job_id):
    while True:
        response = requests.get(
            f"{API_URL}/video/job/{job_id}",
            headers=HEADERS
        )
        status = response.json()

        print(f"Status: {status['status']}")

        if status["status"] == "COMPLETED":
            return status["output"]

        if status["status"] == "FAILED":
            raise Exception(status["error"])

        time.sleep(3)  # Aguarda 3 segundos

# 3. Uso
job_id = submit_video([...])
result = poll_job_status(job_id)
print("Videos:", result["videos"])
```

---

## üîÑ Compara√ß√£o: S√≠ncrono vs Ass√≠ncrono

### **S√≠ncrono (Endpoints Originais)**

```bash
# POST /video/img2vid
# Cliente fica BLOQUEADO at√© completar (~10 minutos)
```

**Vantagens:**
- ‚úÖ Simples (1 request)
- ‚úÖ Recebe resultado imediatamente

**Desvantagens:**
- ‚ùå Cliente bloqueado por 10+ minutos
- ‚ùå Timeout de 15 minutos
- ‚ùå N√£o pode consultar progresso
- ‚ùå Se conex√£o cair, perde tudo

---

### **Ass√≠ncrono (Novos Endpoints)**

```bash
# POST /video/img2vid/async ‚Üí retorna jobId (instant√¢neo)
# GET /video/job/:jobId ‚Üí consulta quando quiser
```

**Vantagens:**
- ‚úÖ Resposta instant√¢nea (<1s)
- ‚úÖ Cliente n√£o fica bloqueado
- ‚úÖ Sem limite de tempo (24h+)
- ‚úÖ Pode fechar e voltar depois
- ‚úÖ M√∫ltiplos jobs simult√¢neos
- ‚úÖ Consulta progresso

**Desvantagens:**
- ‚ö†Ô∏è Requer polling do cliente (2 requests)
- ‚ö†Ô∏è Mais complexo

---

## üìà Casos de Uso

### **Use S√≠ncrono quando:**
- Jobs r√°pidos (<5 minutos)
- Processamento simples (1-2 imagens)
- Cliente pode esperar
- Desenvolvimento/testes

### **Use Ass√≠ncrono quando:**
- Batches grandes (>10 imagens)
- Jobs longos (>5 minutos)
- M√∫ltiplos jobs simult√¢neos
- Cliente n√£o pode ficar bloqueado
- Produ√ß√£o com alta carga

---

## üîß Configura√ß√µes

### **Timeouts**

```typescript
// Express Server (S√≠ncrono)
server.timeout = 900000  // 15 minutos

// Polling Din√¢mico (Ass√≠ncrono)
maxWaitMs: 720000  // 12 minutos (padr√£o)
// Mas pode ser INFINITO no ass√≠ncrono!
```

### **Polling**

```typescript
// Intervalo inicial
delay: 2000ms  // 2 segundos

// Intervalo m√°ximo (exponential backoff)
maxDelay: 8000ms  // 8 segundos

// Progress√£o: 2s ‚Üí 3s ‚Üí 4.5s ‚Üí 6.75s ‚Üí 8s (max)
```

---

## üéØ Best Practices

### 1. **Use Exponential Backoff**
```javascript
let delay = 2000;
const maxDelay = 8000;

while (true) {
  const status = await checkStatus(jobId);
  if (status.status === 'COMPLETED') break;

  await sleep(delay);
  delay = Math.min(delay * 1.5, maxDelay);
}
```

### 2. **Armazene jobId**
```javascript
// Salvar para poder consultar depois
localStorage.setItem('lastJobId', jobId);

// Recuperar em outra sess√£o
const jobId = localStorage.getItem('lastJobId');
```

### 3. **Trate Erros**
```javascript
try {
  const result = await pollJobStatus(jobId);
} catch (error) {
  if (error.message.includes('FAILED')) {
    // Job falhou no RunPod
  } else if (error.message.includes('timeout')) {
    // Timeout local (continua rodando no RunPod)
  }
}
```

### 4. **M√∫ltiplos Jobs**
```javascript
// Submeter todos de uma vez
const jobIds = await Promise.all([
  submitVideo(batch1),
  submitVideo(batch2),
  submitVideo(batch3)
]);

// Aguardar todos
const results = await Promise.all(
  jobIds.map(id => pollJobStatus(id))
);
```

---

## üêõ Troubleshooting

### **Job fica em IN_QUEUE por muito tempo**
- Workers throttled (GPU n√£o dispon√≠vel)
- Aumente `workersMax` no endpoint RunPod
- Use GPUs menos concorridas

### **Status retorna 404**
- JobId inv√°lido
- Job muito antigo (>24h)
- RunPod deletou o job

### **Job falha imediatamente**
- Erro na valida√ß√£o de input
- URLs inv√°lidas/inacess√≠veis
- Verifique logs do worker

---

## üìö Refer√™ncias

- [RunPod Job States](https://docs.runpod.io/serverless/references/job-states)
- [RunPod Send Requests](https://docs.runpod.io/serverless/endpoints/send-requests)
- [C√≥digo fonte: videoProxy.ts](src/orchestrator/routes/videoProxy.ts)

---

## üìù Changelog

**v2.0.0 - Async API**
- ‚úÖ Novos endpoints ass√≠ncronos: `/video/*/async`
- ‚úÖ Polling din√¢mico baseado em tempo
- ‚úÖ Endpoints de status: `GET /video/job/:jobId`
- ‚úÖ Endpoint de resultado: `GET /video/job/:jobId/result`
- ‚úÖ Mant√©m endpoints s√≠ncronos para compatibilidade
- ‚úÖ Sem limite de timeout para async

---

**Implementado em:** 06/10/2025
**Autor:** Claude Code
**Status:** ‚úÖ Produ√ß√£o
